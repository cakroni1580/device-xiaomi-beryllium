name: Build GKI Environment for Poco F1 (Beryllium)

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - lineage-21

jobs:
  build-gki:
    runs-on: ubuntu-22.04

    env:
      KERNEL_REPO: https://github.com/RONNIE158/linux
      KERNEL_BRANCH: gki-5.4
      DEVICE_REPO: https://github.com/cakroni1580/device-xiaomi-beryllium
      DEVICE_BRANCH: main
      ARCH: arm64
      DEVICE: beryllium
      BUILD_DIR: ${{ github.workspace }}/build
      TOOLCHAIN_DIR: ${{ github.workspace }}/toolchains

    steps:
      - name: Checkout device tree
        uses: actions/checkout@v4
        with:
          repository: cakroni1580/device-xiaomi-beryllium
          path: device

      - name: Setup build environment
        run: |
          sudo apt update
          sudo apt install -y git make python3 zip unzip bc bison flex \
            build-essential libssl-dev libncurses5-dev \
            ccache lzop wget curl
          mkdir -p $BUILD_DIR $TOOLCHAIN_DIR

      - name: Clone kernel source
        run: |
          git clone --depth=1 -b $KERNEL_BRANCH $KERNEL_REPO $BUILD_DIR/kernel

      - name: Clone toolchains
        run: |
          cd $TOOLCHAIN_DIR
          git clone --depth=1 -b lineage-20.0 https://github.com/LineageOS/android_prebuilts_clang_kernel_linux-x86_clang-r416183b clang
          git clone --depth=1 -b lineage-19.1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_aarch64_aarch64-linux-android-4.9 aarch64
          git clone --depth=1 -b lineage-19.1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_arm_arm-linux-androideabi-4.9 arm

      - name: Export toolchain paths
        run: |
          echo "PATH=$TOOLCHAIN_DIR/clang/bin:$TOOLCHAIN_DIR/aarch64/bin:$TOOLCHAIN_DIR/arm/bin:$PATH" >> $GITHUB_ENV
          echo "CROSS_COMPILE=aarch64-linux-android-" >> $GITHUB_ENV
          echo "CROSS_COMPILE_ARM32=arm-linux-androideabi-" >> $GITHUB_ENV
          echo "CC=clang" >> $GITHUB_ENV

      - name: Build GKI Kernel
        run: |
          cd $BUILD_DIR/kernel
          make O=out ARCH=$ARCH beryllium_defconfig
          make O=out ARCH=$ARCH CC=clang -j$(nproc)
          cp out/arch/$ARCH/boot/Image.gz-dtb $GITHUB_WORKSPACE/Image.gz-dtb

      - name: Build boot images (vendor_boot + dtbo)
        run: |
          cd $GITHUB_WORKSPACE/device
          bash build_boot_images.sh $GITHUB_WORKSPACE/Image.gz-dtb
          mkdir -p $GITHUB_WORKSPACE/output
          cp out/boot.img out/vendor_boot.img out/dtbo.img $GITHUB_WORKSPACE/output || true

      - name: Package output
        run: |
          cd $GITHUB_WORKSPACE/output
          zip -r9 GKI_Beryllium_Output.zip .

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gki-beryllium-output
          path: ${{ github.workspace }}/output/GKI_Beryllium_Output.zip
