name: Build GKI Images for Poco F1

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  # -----------------------------
  # Job 1: Build vendor.img + dtbo.img
  # -----------------------------
  build_vendor:
    name: Build Vendor & DTBO
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout device tree
        uses: actions/checkout@v4
        with:
          repository: cakroni1580/device-xiaomi-beryllium
          ref: master

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential curl unzip bc git python3 rsync wget

      - name: Clone minimal AOSP for vendor
        run: |
          mkdir -p aosp && cd aosp
          repo init -u https://android.googlesource.com/platform/manifest -b android-14.0.0_r22 --depth=1
          git clone https://github.com/cakroni1580/android-local-manifests.git .repo/local_manifests -b master
          repo sync -c -j$(nproc) \
            build/make \
            system/core \
            frameworks/base \
            device/generic/sdm845
          source build/envsetup.sh

      - name: Copy firmware
        run: |
          mkdir -p out/target/product/sdm845/vendor/firmware
          cp -r firmware/* out/target/product/sdm845/vendor/firmware/

      - name: Build vendor.img
        run: |
          mkdir -p out logs dtbo
          make -C device/generic/sdm845 vendor -j$(nproc) 2>&1 | tee logs/vendor.log
          cp out/target/product/sdm845/vendor.img out/

      - name: Build dtbo.img
        run: |
          mkbootimg.py \
            --dtbo_list device/generic/sdm845/overlay/*.dtbo \
            --output out/dtbo.img || touch out/dtbo.img

      - name: Upload vendor artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gki-vendor-dtbo
          path: |
            out/vendor.img
            out/dtbo.img
            logs/

  # -----------------------------
  # Job 2: Build boot.img & vendor_boot.img
  # -----------------------------
  build_boot:
    name: Build Boot Images
    runs-on: ubuntu-22.04
    needs: build_vendor
    steps:
      - name: Checkout device tree
        uses: actions/checkout@v4
        with:
          repository: cakroni1580/device-xiaomi-beryllium
          ref: master

      - name: Prepare prebuilt kernel
        run: |
          mkdir -p kernel/out
          cp prebuilt-kernel/android-upstream/Image.gz kernel/out/
          cp prebuilt-kernel/android-upstream/sdm845-xiaomi-beryllium.dtb kernel/out/

      - name: Setup Python mkbootimg
        run: |
          mkdir -p ~/android-tools && cd ~/android-tools
          git clone https://android.googlesource.com/platform/system/tools/mkbootimg
          ln -s $PWD/mkbootimg/mkbootimg.py /usr/local/bin/mkbootimg.py
          ln -s $PWD/mkbootimg/repack_bootimg.py /usr/local/bin/repack_bootimg.py
          ln -s $PWD/mkbootimg/unpack_bootimg.py /usr/local/bin/unpack_bootimg.py

      - name: Download vendor artifacts
        uses: actions/download-artifact@v4
        with:
          name: gki-vendor-dtbo
          path: out

      - name: Build boot.img & vendor_boot.img
        run: |
          mkdir -p out
          cp kernel/out/Image.gz out/
          cp kernel/out/sdm845-xiaomi-beryllium.dtb out/

          mkbootimg.py \
            --kernel out/Image.gz --dtb out/sdm845-xiaomi-beryllium.dtb \
            --base 0x80000000 --pagesize 4096 \
            --cmdline "console=ttyMSM0,115200n8 androidboot.hardware=beryllium" \
            --os_version 14.0.0 --output out/boot.img

          mkbootimg.py \
            --kernel out/Image.gz --dtb out/sdm845-xiaomi-beryllium.dtb \
            --base 0x80000000 --pagesize 4096 \
            --cmdline "console=ttyMSM0,115200n8 androidboot.hardware=beryllium" \
            --os_version 14.0.0 --output out/vendor_boot.img

      - name: Upload boot artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gki-boot-images
          path: |
            out/boot.img
            out/vendor_boot.img
