name: Build GKI Android 14 for Poco F1

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  build:
    name: Build Android 14 GKI for Beryllium
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout device tree
        uses: actions/checkout@v4
        with:
          repository: cakroni1580/device-xiaomi-beryllium
          ref: master

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git-core gnupg flex bison build-essential \
            zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 \
            libncurses5-dev x11proto-core-dev libx11-dev libgl1-mesa-dev \
            libxml2-utils xsltproc unzip bc python3 rsync

      
      - name: Clone toolchains
        run: |
          mkdir -p ~/toolchains && cd ~/toolchains

          git clone --depth=1 -b lineage-20.0 https://github.com/LineageOS/android_prebuilts_clang_kernel_linux-x86_clang-r416183b clang
          git clone --depth=1 -b lineage-19.1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_aarch64_aarch64-linux-android-4.9 aarch64
          git clone --depth=1 -b lineage-19.1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_arm_arm-linux-androideabi-4.9 arm

      - name: Install repo tool
        run: |
          sudo curl -o /usr/local/bin/repo https://storage.googleapis.com/git-repo-downloads/repo
          sudo chmod a+x /usr/local/bin/repo
          repo --version
    
      - name: Prepare kernel prebuilt
        run: |
          mkdir -p kernel/out
          cp prebuilt-kernel/android-upstream/Image.gz kernel/out/
          cp prebuilt-kernel/android-upstream/sdm845-xiaomi-beryllium.dtb kernel/out/
          echo "âœ… Prebuilt kernel ready"

      - name: Clone AOSP Android 14 GKI
        run: |
          mkdir aosp && cd aosp
          repo init -u https://android.googlesource.com/platform/manifest -b android-14.0.0_r1
          repo sync -c -j$(nproc)

      - name: Setup environment
        run: |
          export PATH=$PATH:~/toolchains/clang/bin:~/toolchains/aarch64/bin:~/toolchains/arm/bin
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-android-
          export CROSS_COMPILE_ARM32=arm-linux-androideabi-
          export CLANG_TRIPLE=aarch64-linux-gnu-
          echo "Environment ready"

      - name: Build boot images
        run: |
          mkdir out
          cp kernel/out/Image.gz out/
          cp kernel/out/sdm845-xiaomi-beryllium.dtb out/

          mkbootimg \
            --kernel out/Image.gz \
            --dtb out/sdm845-xiaomi-beryllium.dtb \
            --base 0x00000000 \
            --pagesize 4096 \
            --cmdline "console=ttyMSM0,115200n8 androidboot.hardware=beryllium" \
            --os_version 14.0.0 \
            --output boot.img

          echo "Boot image done"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gki-bootimg-beryllium
          path: boot.img
